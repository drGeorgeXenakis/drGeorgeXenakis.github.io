---
title: "Drought manipulation SPAC hydraulic efficiency vs gas exchange"
author: "George Xenakis"
date: "2023-03-27"
output: 
  html_document: 
    fig_caption: yes
  word_document: default
  pdf_document: 
    fig_caption: yes
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      error = FALSE, 
                      message = FALSE, 
                      evaluate=TRUE,
                      results = 'hide')

knitr::opts_knit$set(kable.force.latex = FALSE)

```


```{r}
###################################################
## Script that calculates the hydraulic efficiency
## for the DTCLASS drought manipulation experiment
## Georgios Xenakis - 10/03/2022
## email: georgios.xenakis@forestresearch.gov.uk
####################################################
dtclassDir <- "/home/george/Documents/DTCLASS/data/"
rawGasExchangeDir <- paste0(dtclassDir,"raw/gas_exchange/")

## Load the libraries
library(bigleaf)
library(stringr)
library(photosynthesis)

## The colour palette to use for some of the graphs
jet.colours <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
colours<-jet.colours(7)
colours12 <- jet.colours(12)

## ------------------------------------------------------------------------ ##
## Custom function using Saxton's equations
source(system("echo /home/george/Documents/ManForC_Greenhouse/data/processed/scripts/data_analysis/saxton.r",intern=T))
## ------------------------------------------------------------------------ ##
## Custom function to calculate all the necessary variables to apply the
## circut theory
circuitTheory <- function(sap,soil,met,S=40,C=18){
    options(warn=-1)
    tN <- sap%>%select(treeNo)%>%unique()%>%as.numeric()
    D <- sap%>%
        select(timestamp,sf_tot,treeNo)%>%
        left_join(soil%>%filter(treeNo==tN)%>%select(timestamp,vwc),by="timestamp")%>%
        left_join(met%>%select(timestamp,tair_mean,rh_mean),by="timestamp")%>%
        drop_na()%>%
        mutate(T=(tair_mean+273.15),
               RH=rh_mean/100)%>%
        createTimestamp(data=.,timestamp="timestamp")%>%
        group_by(timestamp=as.POSIXct(cut(timestamp,breaks="30 min")),treeNo)%>%
        summarise(sumSF=sum(sf_tot),                       ## Total sap flow [L/h]
                  theta=mean(vwc,na.rm=T),                 ## VWC [%]
                  T=mean(T),                               ## Mean air temperature [oC]
                  RH=mean(RH)                              ## Mean relative humidity [fraction]
                  )%>%
        mutate(psiAir=((8.3145*T)/1.80E-05)*log(RH)*1e-3,  ## Air water potential [kPa]
               psi=-saxton(theta=theta,S=S,C=C)[["psi"]],  ## Soil water potential [kPa]
               DeltaPsi=psi-psiAir,                        ## Soil-air water potential differential [kPa]
               Pw=0.000277777778*sumSF*DeltaPsi,           ## Hydraulic power [W] - 0.27 from ΔΨ*Q
               Kl=2.77777778e-10 * ((sumSF/DeltaPsi)*1),   ## Plant conductance [m/s] - 2.7e-10 from ΔΨ/Q,
               ## multiplied by water density ~1kg/m3 UNITS: ((L/hr)/kPa)*kg/m3
               Ks=saxton(theta=theta,S=S,C=C)[["K"]],      ## Soil conductance [m/s]
               Rs=1/Ks,                                    ## Soil Resistance
               Rl=1/Kl,                                    ## Plant resistance [s/m] - 3.6e9 from ΔΨ/Q
               Ps = ((DeltaPsi^2) / (Rl*((sqrt(Rs)/sqrt(Rl))+(sqrt(Rl)/sqrt(Rs)))^2)),  ## Soil power [W]
               Ppl = ((DeltaPsi^2) / (Rs*((sqrt(Rs)/sqrt(Rl))+(sqrt(Rl)/sqrt(Rs)))^2)), ## Plant power [W]
               n = (Ppl / (Ppl + Ps))                      ## SPAC hydraulic efficiency [unitless]
               )%>%createTimestamp(data=.,timestamp="timestamp")
    return(D)
}
## ------------------------------------------------------------------------ ##
## Function to plot SPAC hydraulic efficiency
plotSPACEff <- function(data){
    minTS <- min(data$timestamp)
    maxTS <- max(data$timestamp)
    data%>%
        ggplot(data=.)+plotAesthetic+
        annotate("rect",xmin=minTS,xmax=maxTS,ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
        ## area of most efficient water transport
        annotate("rect",xmin=minTS,xmax=maxTS,ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
        ## area of moderately efficient water transport
        annotate("rect",xmin=minTS,xmax=maxTS,ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
        ## area of moderately unrestricted of water transport
        annotate("rect",xmin=minTS,xmax=maxTS,ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
        ## area of unrestricted water supply
        annotate("rect",xmin=minTS,xmax=maxTS,ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
        ## geom_raster(aes(x=as.Date(timestamp),y=hour,fill=n),interpolate=TRUE)+
        ## geom_raster(aes(x=as.Date(timestamp),y=hour,fill=n),interpolate=TRUE)+
        ## scale_fill_gradientn(colours=rev(colours),name=expression(paste(eta," [unitless]", sep = " ")),limits=c(0,1))+ ##,
        ## scale_y_continuous(breaks=seq(0,23,4),labels=seq(0,23,4),name="Hour")+
        ## scale_x_date(limits=c(as.Date("2021-05-25"),as.Date("2021-08-18")),
        ##              breaks=seq(as.Date("2021-05-25",tz="GMT"),as.Date("2021-08-18",tz="GMT"),by="10 day"),
        ##              labels = date_format("%d\n%b"),name="Timestamp"
        ##              )+
        geom_line(aes(x=timestamp,y=n))+
        geom_hline(yintercept=0,linetype=3)+
        scale_y_continuous(name=expression(paste(eta," [unitless]", sep = " ")),limits=c(0,1))+
        scale_x_datetime(limits=c(minTS,maxTS),
                         breaks=seq(minTS,maxTS,by="10 day"),
                         labels = date_format("%d\n%b"),name="Timestamp")+
        theme(#panel.grid=element_blank(),
              plot.margin=unit(c(0,0,0,1),"cm"),
              strip.text=element_blank(),
              ## strip.background=element_blank(),
              axis.text.y=element_text(size=16,colour="black"),
              axis.title.y=element_text(size=16),
              legend.text=element_text(size=16),
              legend.title=element_text(size=16),
              axis.text.x=element_text(size=16),#element_blank(),#
              axis.title.x=element_text(size=16),#=element_blank(),
              plot.title=element_text(size=16,hjust=0.5))
}
## ------------------------------------------------------------------------ ##
## Function to plot sap flow
plotSapFlow <- function(data){
    data%>%createTimestamp(data=.,timestamp="timestamp")%>%
        ggplot(data=.)+plotAesthetic+
            ##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##
            ## geom_line(aes(x=timestamp,y=sf_tot*0.001))+
            ## geom_hline(yintercept=0,linetype=3)+
            ## scale_y_continuous(limits=c(-1,8),name=expression(paste(J, " [L/m]", sep = " ")))+
            ## scale_x_datetime(limits=c(as.POSIXct("2021-05-25"),as.POSIXct("2021-08-18")),
            ##                  breaks=seq(as.POSIXct("2021-05-25",tz="GMT"),as.POSIXct("2021-08-18",tz="GMT"),by="10 day"),
            ##                  labels = date_format("%d\n%b"),name="Timestamp"
            ##                  )+
            ##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##
            geom_raster(aes(x=as.Date(timestamp),y=hour,fill=sf_tot*0.001),interpolate=TRUE)+
            scale_fill_gradientn(colours=colours,name=expression(paste(J, " [L ", hr^-1,"]", sep = " ")),limits=c(0,1))+ ##,
            scale_y_continuous(breaks=seq(0,23,4),labels=seq(0,23,4),name="Hour")+
            scale_x_date(#limits=c(as.Date("2021-05-25"),as.Date("2021-08-18")),
                         #breaks=seq(as.Date("2021-05-25",tz="GMT"),as.Date("2021-08-18",tz="GMT"),by="10 day"),
                         labels = date_format("%d\n%b"),name="Timestamp"
                         )+
            ##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##
            theme(#panel.grid=element_blank(),
                  plot.margin=unit(c(0,0,0,1),"cm"),
                  strip.text=element_blank(),
                  ## strip.background=element_blank(),
                  axis.text.y=element_text(size=16,colour="black"),
                  axis.title.y=element_text(size=16),
                  legend.text=element_text(size=16),
                  legend.title=element_text(size=16),
                  axis.text.x=element_text(size=16),#element_blank(),#
                  axis.title.x=element_text(size=16),#element_blank(),
                  plot.title=element_text(size=16))
}
## ------------------------------------------------------------------------ ##
## Function to plot soil water content
plotWaterContent <- function(data){
    data%>%
        ggplot(data=.)+plotAesthetic+
        geom_line(aes(x=timestamp,y=theta*100))+
        ## geom_raster(aes(x=as.Date(timestamp),y=hour,fill=theta),interpolate=TRUE)+
        ## geom_raster(aes(x=as.Date(timestamp),y=hour,fill=n),interpolate=TRUE)+
        ## scale_fill_gradientn(colours=colours,name=expression(paste(theta, " [%]", sep = " ")))+ ##limits=c(0,100),
        scale_y_continuous(name=expression(paste(theta, " [%]", sep = " ")),limit=c(0,50,10),breaks=seq(0,50,10))+
        scale_x_datetime(limits=c(as.POSIXct("2021-05-25"),as.POSIXct("2021-08-18")),
                         breaks=seq(as.POSIXct("2021-05-25",tz="GMT"),as.POSIXct("2021-08-18",tz="GMT"),by="10 day"),
                         labels = date_format("%d\n%b"),name="Timestamp"
                         )+
        theme(#panel.grid=element_blank(),
              plot.margin=unit(c(0,0,0,1),"cm"),
              strip.text=element_blank(),
              ## strip.background=element_blank(),
              axis.text.y=element_text(size=16,colour="black"),
              axis.title.y=element_text(size=16),
              legend.text=element_text(size=16),
              legend.title=element_text(size=16),
              axis.text.x=element_text(size=16),#element_blank(),#
              axis.title.x=element_text(size=16),#element_blank(),
              plot.title=element_text(size=16))
}
## ------------------------------------------------------------------------ ##
## A function that calculates the hydraulic efficiency,
## to use for the response function graph
efficiency <- function(T,RH,theta,SF,S=40,C=18){
    psiAir=((8.3145*T)/1.80E-05)*log(RH)*1e-3
    psi=-saxton(theta=theta)[["psi"]]
    DeltaPsi=psi-psiAir
    Pw=0.000277777778*SF*DeltaPsi
    Kl=2.77777778e-10 * ((SF/DeltaPsi)/1)
    Ks=saxton(theta=theta,S=S,C=C)[["K"]]
    Rs=1/Ks
    Rl=1/Kl
    Ps = ((DeltaPsi^2) / (Rl*((sqrt(Rs)/sqrt(Rl))+(sqrt(Rl)/sqrt(Rs)))^2))
    Ppl = ((DeltaPsi^2) / (Rs*((sqrt(Rs)/sqrt(Rl))+(sqrt(Rl)/sqrt(Rs)))^2))
    n = (Ppl / (Ppl + Ps))
    return(list("n"=n,"Rl"=Rl,"Rs"=Rs,"Ppl"=Ppl,"psiAir"=psiAir,"psi"=psi,"DeltaPsi"=DeltaPsi))
}
## ------------------------------------------------------------------------ ##
## A function that calculates the hydraulic efficiency of a non-steady state electric circuit, used to build response functions for sensitivity analysis
efficiency.NSS <- function(T,RH,theta,SF,S=40,C=18,capacitance=1e-5){
    ## 1e-5 stem capacitance [L/kPa] - From Edwards and Jarvis 1982 - Plant, Cell & Environemnt [1e-11 m3/Pa]
    psiAir=((8.3145*T)/1.80E-05)*log(RH)*1e-3
    psiAir_t=lag(psiAir,default=first(.))      ## Difference of air water potential [kPa]
    psiAir_dt=psiAir_t/0.5                     ## Differential of air water potential with time [kPa/h]
    Fstg=capacitance*psiAir_dt                 ## Water flux in stem due to 
    psi=-saxton(theta=theta)[["psi"]]
    DeltaPsi=psi-psiAir
    Kl=2.77777778e-10 * (((SF+Fstg)/DeltaPsi)*1)
    Ks=saxton(theta=theta,S=S,C=C)[["K"]]
    Rs=1/Ks
    Rl=1/Kl
    Ps = ((DeltaPsi^2) / (Rl*((sqrt(Rs)/sqrt(Rl))+(sqrt(Rl)/sqrt(Rs)))^2))
    Ppl = ((DeltaPsi^2) / (Rs*((sqrt(Rs)/sqrt(Rl))+(sqrt(Rl)/sqrt(Rs)))^2))
    n = (Ppl / (Ppl + Ps))
    return(list("n"=n,"Rl"=Rl,"Rs"=Rs,"Ppl"=Ppl,"psiAir"=psiAir,"psi"=psi,"DeltaPsi"=DeltaPsi,"Fst"=Fstg))
}
## ------------------------------------------------------------------------ ##
## A custom function that calculates for a data frame
## all the necessary variables from the custom hydraulic efficiency function
mutateEfficiency <- function(dataFrame,state="steady",capacitance=1e-5){
    if(state=="steady"){
        dataFrame <- dataFrame%>%mutate(efficiency=efficiency(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default)[["n"]],
                                        Rl=efficiency(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default)[["Rl"]],
                                        Rs=efficiency(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default)[["Rs"]],
                                        Ppl=efficiency(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default)[["Ppl"]],
                                        psiAir=efficiency(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default)[["psiAir"]],
                                        DeltaPsi=efficiency(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default)[["DeltaPsi"]],
                                        rl.rs=Rl/Rs)
    }else if(state=="non-steady"){
        dataFrame <- dataFrame%>%mutate(efficiency=efficiency.NSS(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default,capacitance=capacitance)[["n"]],
                                        Rl=efficiency.NSS(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default,capacitance=capacitance)[["Rl"]],
                                        Rs=efficiency.NSS(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default,capacitance=capacitance)[["Rs"]],
                                        Ppl=efficiency.NSS(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default,capacitance=capacitance)[["Ppl"]],
                                        psiAir=efficiency.NSS(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default,capacitance=capacitance)[["psiAir"]],
                                        DeltaPsi=efficiency.NSS(T=ta,RH=rh,theta=theta,SF=sf,S=sand.default,C=clay.default,capacitance=capacitance)[["DeltaPsi"]],
                                        rl.rs=Rl/Rs)
    }
    return(dataFrame)
}
## ------------------------------------------------------------------------ ##
se.f <- function(x,na.rm=FALSE) x <- sd(x,na.rm=na.rm)/sqrt(length(x))
## ------------------------------------------------------------------------ ##
meanPerDate <- function(data,datesArray){
    start <- as.POSIXct(datesArray,tz="GMT")+lubridate::hours(8)
    end <- as.POSIXct(datesArray,tz="GMT")+lubridate::hours(16)
    l <- list()
    for(i in 1:length(datesArray)){
        l[[i]] <- data%>%filter(between(timestamp,start[[i]],end[[i]]))%>%
            group_by(timestamp=as.Date(timestamp))%>%
            summarise(across(1:16,.f=list(mean=mean,se=se.f)))
    }
    d <- do.call("rbind",l)
}
## Function to get the dates for certain type of measurements (e.g., light curves, co2 curves)
extractSamplingDates <- function(path,type){
    dates <- system(paste0('find ',path, ' \\( -iname "*',type,'*" ! -iname "*flow*" ! -iname "*original*"  \\) | sort'),intern=T)%>%strsplit(.,"/")%>%do.call("rbind",.)%>%as.data.frame()%>%pull("V9")%>%unique()
    return(dates)
}


## A function to read the LI6800 dataset
readLicorData <- function(path,type,specificVar=TRUE){
    ## read the file names in the path given for the type of curve (i.e., light or a/ci curve)
    fileNames <- system(paste0('find ',path, ' \\( -iname "*',type,'*" ! -iname "*flow*" ! -iname "*original*"  ! -iname "*C-15*" ! -iname "*MD-7*" \\) | sort'),intern=T)
    ## read the files and each data frame put in a list
    ## l <- lapply(fileNames,readFile,nSkip=67,nSkipNames=65,sep="\t")
    l <- lapply(fileNames,photosynthesis::read_li6800)
    if(specificVar) l <- lapply(l,selectSpecificVariables,type=type)
    ## for each data frame read put the treatment and number of the tree,
    ## extracted from the file name
    if(type!="survey"){
        for(i in 1:length(fileNames)){
            l[[i]] <- l[[i]]%>%mutate(id=fileNames[i]%>%strsplit(.,"_")%>%do.call("rbind",.)%>%as.data.frame%>%pull("V6"),.before=2)
        }
    }else{
        for(i in 1:length(fileNames)){
            l[[i]] <- l[[i]]%>%mutate(id=fileNames[i]%>%strsplit(.,"_")%>%do.call("rbind",.)%>%as.data.frame%>%pull("V5"),.before=2)
        }            
    }
    return(l)
}

## Function to select specific range of columns from the licor data
selectSpecificVariables <- function(data,type){
    if(type!="survey"){
        data <- data%>%select(1:62,Q)
    }else{
        data <- data%>%select(date,A,gsw,iWUE)
    }
}

## ## A custom function to calculate the standard error of the mean
## se.f <- function(x,na.rm=FALSE) x <- sd(x,na.rm=na.rm)/sqrt(length(x))

## A function to remove rows within the data where there is text
## (i.e., changes to the parameters during a measurement)
cleanLicorData <- function(data){
    data <- data%>%mutate(date=ifelse(is.na(A),NA,date))%>%
        drop_na(A)
}
## ======================================================================== ##

## Set up some directory locations
dtclassDir <- "/home/george/Documents/DTCLASS/data/"


biomet <- readRDS(file=paste0(dtclassDir,"processed/biomet/biomet.RDS"))
sapData <- readRDS(file=paste0(dtclassDir,"processed/sapflow/sapData.RDS"))
soil.moist <- readFile(system(paste0("echo ",dtclassDir,"processed/swc/swc.csv"),intern=T),h=T,show_col_types=FALSE)
smN <- c(3,4,7,8,10,11,12,16)
treeID <- c("C-6","C-8","C-12","MD-2","MD-5","MD-16")
treeOrder <- c(6,8,12,2,5,16)

## Read the leaf area adjustment file
leafAreaAdj <- readFile(paste0(dtclassDir,"/processed/leaf_area/leaf_area_adj.csv"),h=T)%>%select(id,adj)


## ~~~~~~~~~~~~~~ Fit light curves ~~~~~~~~~~~~~~~~~ ##

## Get from the raw data file directory for which dates
## we have light curve measurements    
lightCurveDates <- extractSamplingDates(path=rawGasExchangeDir,type="light_curve")


## Custom function to fit light curves and give fitted parameters in a data frame for each fit as a list
fitLightCurves <- function(arg="par"){
    lightCurveParFitList <- list()
    lightCurveGraphList <- list()
    ## A loop to fit the light curves for each plant, for each sampling date
    for(k in 1:length(lightCurveDates)){

        ## First read the licor data for a specific sampling date
        lightCurveList <- readLicorData(path=paste0(rawGasExchangeDir,lightCurveDates[k]),type="light_curve")
        
        ## Convert the list of data frames into one data frame
        lightCurves <- do.call("rbind",lightCurveList)
        
        ## Merge the leaf area adjustement data frame and calculate the adjusted variable
        ## (i.e., photosynthesis, conductance and water use efficiency)
        lightCurves <- lightCurves%>%
            left_join(leafAreaAdj,by="id")%>%
            mutate(A=A*adj,
                   gsw=gsw*adj,
                   iWUE=iWUE*adj)%>%
            select(id,A,Qabs)%>%as.data.frame
        
        
        ## fits <- fit_many(
        ##     data=lightCurves,
        ##     varnames=list(
        ##         A_net="A",
        ##         PPFD="Qabs"
        ##     ),
        ##     funct=fit_aq_response,
        ##     group="id")

        fits <- lightCurves%>%
            split(~id)%>%
            map(fit_photosynthesis,
                .photo_fun="aq_response",
                .vars=list(
                    .A=A,
                    .Q=Qabs))
        
        
        fits_pars <- lapply(fits,coef)%>%
            do.call("rbind",.)%>%
            as.data.frame%>%
            rownames_to_column(., var="id")%>%
            as_tibble()%>%
            mutate(date=lightCurveDates[k],.before=1)%>%
            separate(id,c("treatment","tree"))

        ## fits_graphs <- compile_data(fits,
        ##                             list_element=3)
        
        ## fits_pars <- compile_data(fits,
        ##                           output_type="dataframe",
        ##                           list_element=2)%>%
        ##     mutate(date=lightCurveDates[k],.before=1)%>%
        ##     separate(ID,c("treatment","tree"))
        
        lightCurveParFitList[k] <- list(fits_pars)
        ## lightCurveGraphList[k] <- list(fits_graphs)
    }
    ## if(arg=="par"){
        return(lightCurveParFitList)
    ## }else if(arg=="graph"){
    ##     return(lightCurveGraphList)
    ## }
}


## Run the fitting function for light curves and get the parameters
## and save the exported list 
lightCurveParFitList <- fitLightCurves()
## lightCurveGraphList <- fitLightCurves("graph")

## Plot fitted light curves
## graphics.off()
## for(k in 1:length(lightCurveDates)){
##     x11();
##     egg::ggarrange(plots=lightCurveGraphList[[k]])
## }


## Combine fitted parameters list into a data frame
lightCurveParFit <- do.call("rbind",lightCurveParFitList)

## Get from the raw data file directory for which dates
## we have a/ci curve measurements
aciCurveDates <- extractSamplingDates(path=rawGasExchangeDir,type="co2_curve")[1:3]



## Custom function to fit aci curves and give fitted parameters in a data frame for each fit as a list
fitAciCurves <- function(arg="par"){
    aciCurveParFitList <- list()
    aciCurveGraphList <- list()
    ## A loop to fit the aci curves for each plant, for each sampling date
    for(k in 1:length(aciCurveDates)){

        ## First read the licor data for a specific sampling date
        aciCurveList <- readLicorData(path=paste0(rawGasExchangeDir,aciCurveDates[k]),type="co2_curve")
        
        ## Convert the list of data frames into one data frame
        aciCurves <- do.call("rbind",aciCurveList)
        
        ## Merge the leaf area adjustement data frame and calculate the adjusted variable
        ## (i.e., photosynthesis, conductance and water use efficiency)
        aciCurves <- aciCurves%>%
            left_join(leafAreaAdj,by="id")%>%
            mutate(A=A*adj,
                   gsw=gsw*adj,
                   iWUE=iWUE*adj,
                   Tleaf=TleafEB+273.15)##  %>%
        ## filter(id!="MD-5")
        
        
        ## fits <- fit_many(
        ##     data=data.frame(aciCurves),
        ##     .vars=list(
        ##         .A=A,
        ##         .Q=Qabs),
        ##     .photo_fun = "aq_response",
        ##     funct=fit_photosynthesis,
        ##     group="id")

        ## fits <- aciCurves%>%
        ##     split(~id)%>%
        ##     map(fit_photosynthesis,
        ##         .photo_fun="aci_response",
        ##         .vars=list(
        ##             .A=A,
        ##             .C_i=Ci))

        fits <- fit_many(
            data=aciCurves,
            varnames=list(
                A_net="A",
                T_leaf="Tleaf",
                C_i="Ci",
                PPFD="Qabs"
            ),
            funct=fit_aci_response,
            group="id")
        
        fits_graphs <- compile_data(fits,
                                    list_element=2)
        
        fits_pars <- compile_data(fits,
                                  output_type="dataframe",
                                  list_element=1)%>%
            mutate(date=aciCurveDates[k],.before=1)%>%
            separate(ID,c("treatment","tree"))
        
        aciCurveParFitList[k] <- list(fits_pars)
        aciCurveGraphList[k] <- list(fits_graphs)
    }
    if(arg=="par"){
        return(aciCurveParFitList)
    }else if(arg=="graph"){
        return(aciCurveGraphList)
    }
}


## Run the fitting function for A/Ci curves and get the parameters
## and save the exported list 
aciCurveParFitList <- fitAciCurves("par")


## Plot fitted aci curves
## for(k in 1:length(aciCurveDates)){
##     x11();
##     egg::ggarrange(plots=aciCurveGraphList[[k]])
## }

## Combine fitted parameters list into a data frame
aciCurveParFit <- do.call("rbind",aciCurveParFitList)

```

```{r}
sapDataCT <- readRDS(file=paste0(dtclassDir,"processed/sapflow/sapDataCT.RDS"))

## Put the data in one data frame
sDCT <- do.call("rbind",sapDataCT)
```

## Hydraulic efficiency of the soil-plant-atmosphere continuum
The plots show the efficiency for each tree, three control (top) and tree drought (bottom). The highlighted areas show each zone of the hydrualic efficiency. We see that $\eta$ drops rapidly when watering stops and rapidly increased when water is reintroduced. The sharp decline/increase is because there is very little "natural" drainage and the treatment was very harsh.

```{r, fig.width=18, fig.height=10}
pLSPACEff <- lapply(sapDataCT,plotSPACEff)

egg::ggarrange(plots=pLSPACEff,nrow=2,ncol=3)
```


## Empirical cumulative density function
The ECD plot is used to show the percentage of the data that are within a specific hydraulic efficiency zone. From that, we can calculate how many days the tree has been water stressed and how many has not.


```{r}
## ECDF plots for each tree (Empirical Cumulative Density Function)
tibble(treeNo=treeOrder,id=treeID)%>%right_join(sDCT,by="treeNo")%>%
    select(timestamp,id,n)%>%
    ggplot(data=.,aes(x=n,group=id,colour=as.factor(id)))+
    plotAesthetic+
        ## area of potential water stress
        annotate("rect",ymin=0,ymax=1,xmin=0,xmax=0.412,fill="orangered",alpha=0.2,colour=NA)+
        ## area of most efficient water transport
        annotate("rect",ymin=0,ymax=1,xmin=0.412,xmax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
        ## area of moderately efficient water transport
        annotate("rect",ymin=0,ymax=1,xmin=0.565,xmax=0.75,fill="cyan",alpha=0.2,colour=NA)+
        ## area of moderately unrestricted of water transport
        annotate("rect",ymin=0,ymax=1,xmin=0.75,xmax=0.89,fill="magenta",alpha=0.2,colour=NA)+
        ## area of unrestricted water supply
        annotate("rect",ymin=0,ymax=1,xmin=0.89,xmax=1,fill="grey90",alpha=0.4,colour=NA)+
        stat_ecdf(size=0.7,geom="line")+
        scale_y_continuous(breaks=seq(0,1,.1),name=expression(paste(italic(F[C]),"",sep=" ")),expand=c(0,0))+
        scale_x_continuous(breaks=seq(0,1,.1),name=expression(paste(eta," [unitless]",sep=" ")),expand=c(0,0))+
        scale_colour_manual(name="ID",values=c(1,2,3,4,5,6))+
        ## scale_linetype_discrete(name="ID")+
        ## annotate(geom="text",label="0.83",x=0.45,y=0.85)+
        theme(#panel.grid=element_blank(),
           ## plot.margin=unit(c(0,0,0,1),"cm"),
            strip.text=element_blank(),
            ## strip.background=element_blank(),
            axis.text.y=element_text(size=16,colour="black"),
            axis.title.y=element_text(size=16),
            legend.text=element_text(size=16),
            legend.title=element_text(size=16),
            axis.text.x=element_text(size=16),#element_blank(),#
            axis.title.x=element_text(size=16),#element_blank(),
            plot.title=element_text(size=16),
            legend.key.width = unit(1,"cm")       
)

```


```{r}
## ~~~~~~~~~~~~~~~~ Mean Efficiency per Light Curve date ~~~~~~~~~~~~~~~ ##

meanEfficiencyLightCurveList <- list()
meanEfficiencyLightCurveList <- lapply(sapDataCT,meanPerDate,datesArray=lightCurveDates)

meanEfficiencyLightCurveDate <- do.call("rbind",meanEfficiencyLightCurveList)%>%
    select(-treeNo_se)%>%
    rename(treeNo=treeNo_mean)%>%
    left_join(tibble(treeNo=treeOrder,id=treeID),by="treeNo")%>%
    rename(date=timestamp)
    
lightCurveEff <- lightCurveParFit%>%
    unite(id,c("treatment","tree"),sep="-")%>%
    mutate(date=as.Date(date))%>%
    left_join(meanEfficiencyLightCurveDate,by=c("date","id"))%>%
    mutate(ID=id)%>%
    separate(ID,c("treatment","treeNo"))




## The Michaelis-Menten kinetics function
Michaelis_Menten<-function(x,slope,sat,r){
  (slope*x/(sat+x))+r
}

## Fit the model for Ksat vs mean efficiency
fit.ksat <- nlsLM(data = lightCurveEff, n_mean ~ Michaelis_Menten(k_sat,slope=slope,sat,r),
                 start = list(sat = 0.9,
                              slope = 1,
                              r = 1),
                 ## lower = c(min(cntr$A),0, 0, 0),
                 ## upper = c(10 * max(abs(cntr$A)), 0.5, 1, max(abs(cntr$A))),
                 control = nls.lm.control(maxiter = 1000))
summary(fit.ksat)
calculateRsq(data=lightCurveEff,modelFit = fit.ksat,depVar = n_mean)
pred.ksat<-tibble(ksat=seq(0,30,0.5),n.pred=Michaelis_Menten(ksat,slope=coef(fit.ksat)[[2]],sat=coef(fit.ksat)[[1]],r=coef(fit.ksat)[[3]]))

## Fit the model for PhiJ vs mean efficiency
fit.phiJ <- nlsLM(data = lightCurveEff, n_mean ~ Michaelis_Menten(phi_J,slope=slope,sat,r),
                 start = list(sat = 0.9,
                              slope = 1,
                              r = 1),
                 ## lower = c(min(cntr$A),0, 0, 0),
                 ## upper = c(10 * max(abs(cntr$A)), 0.5, 1, max(abs(cntr$A))),
                 control = nls.lm.control(maxiter = 1000))
summary(fit.phiJ)
calculateRsq(data=lightCurveEff,modelFit = fit.phiJ,depVar = n_mean)
pred.phiJ<-tibble(phiJ=seq(0,0.3,0.005),n.pred=Michaelis_Menten(phiJ,slope=coef(fit.phiJ)[[2]],sat=coef(fit.phiJ)[[1]],r=coef(fit.phiJ)[[3]]))







labels <- c("First wet","First drought","Second wet","Second drought")
names(labels) <- lightCurveDates

pEff.kSat <- lightCurveEff%>%
    ggplot(.)+
    geom_point(aes(k_sat,n_mean,shape=treatment,colour=as.factor(date)),size=3)+
    geom_line(data=pred.ksat,aes(x=ksat,y=n.pred))+
    plotAesthetic+
    annotate("rect",xmin=min(lightCurveEff$k_sat),xmax=max(lightCurveEff$k_sat),ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
    ## area of most efficient water transport
    annotate("rect",xmin=min(lightCurveEff$k_sat),xmax=max(lightCurveEff$k_sat),ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
    ## area of moderately efficient water transport
    annotate("rect",xmin=min(lightCurveEff$k_sat),xmax=max(lightCurveEff$k_sat),ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
    ## area of moderately unrestricted of water transport
    annotate("rect",xmin=min(lightCurveEff$k_sat),xmax=max(lightCurveEff$k_sat),ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
    ## area of unrestricted water supply
    annotate("rect",xmin=min(lightCurveEff$k_sat),xmax=max(lightCurveEff$k_sat),ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
    scale_colour_manual(values=c(1,2,3,4),labels=labels,name="Period")+
    scale_shape_discrete(name="Treatment")+
    theme(#panel.grid=element_blank(),
        plot.margin=unit(c(0,0,0,1),"cm"),
        strip.text=element_blank(),
        ## strip.background=element_blank(),
        axis.text.y=element_text(size=16,colour="black"),
        axis.title.y=element_text(size=16),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        axis.text.x=element_text(size=16),#element_blank(),#
        axis.title.x=element_text(size=16),#=element_blank(),
        plot.title=element_text(size=16,hjust=0.5))


pEff.phiJ <- lightCurveEff%>%
    ggplot(.)+
    geom_point(aes(phi_J,n_mean,shape=treatment,colour=as.factor(date)),size=3)+
    geom_line(data=pred.phiJ,aes(x=phiJ,y=n.pred))+
    plotAesthetic+
    annotate("rect",xmin=min(lightCurveEff$phi_J),xmax=max(lightCurveEff$phi_J),ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
    ## area of most efficient water transport
    annotate("rect",xmin=min(lightCurveEff$phi_J),xmax=max(lightCurveEff$phi_J),ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
    ## area of moderately efficient water transport
    annotate("rect",xmin=min(lightCurveEff$phi_J),xmax=max(lightCurveEff$phi_J),ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
    ## area of moderately unrestricted of water transport
    annotate("rect",xmin=min(lightCurveEff$phi_J),xmax=max(lightCurveEff$phi_J),ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
    ## area of unrestricted water supply
    annotate("rect",xmin=min(lightCurveEff$phi_J),xmax=max(lightCurveEff$phi_J),ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
    scale_colour_manual(values=c(1,2,3,4),labels=labels,name="Period")+
    scale_shape_discrete(name="Treatment")+
    theme(#panel.grid=element_blank(),
        plot.margin=unit(c(0,0,0,1),"cm"),
        strip.text=element_blank(),
        ## strip.background=element_blank(),
        axis.text.y=element_text(size=16,colour="black"),
        axis.title.y=element_text(size=16),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        axis.text.x=element_text(size=16),#element_blank(),#
        axis.title.x=element_text(size=16),#=element_blank(),
        plot.title=element_text(size=16,hjust=0.5))


pEff.Rd <- lightCurveEff%>%
    ggplot(.)+
    geom_point(aes(Rd,n_mean,shape=treatment,colour=as.factor(date)),size=3)+
    plotAesthetic+
    annotate("rect",xmin=min(lightCurveEff$Rd),xmax=max(lightCurveEff$Rd),ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
    ## area of most efficient water transport
    annotate("rect",xmin=min(lightCurveEff$Rd),xmax=max(lightCurveEff$Rd),ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
    ## area of moderately efficient water transport
    annotate("rect",xmin=min(lightCurveEff$Rd),xmax=max(lightCurveEff$Rd),ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
    ## area of moderately unrestricted of water transport
    annotate("rect",xmin=min(lightCurveEff$Rd),xmax=max(lightCurveEff$Rd),ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
    ## area of unrestricted water supply
    annotate("rect",xmin=min(lightCurveEff$Rd),xmax=max(lightCurveEff$Rd),ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
    scale_colour_manual(values=c(1,2,3,4),labels=labels,name="Period")+
    scale_shape_discrete(name="Treatment")+
    theme(#panel.grid=element_blank(),
        plot.margin=unit(c(0,0,0,1),"cm"),
        strip.text=element_blank(),
        ## strip.background=element_blank(),
        axis.text.y=element_text(size=16,colour="black"),
        axis.title.y=element_text(size=16),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        axis.text.x=element_text(size=16),#element_blank(),#
        axis.title.x=element_text(size=16),#=element_blank(),
        plot.title=element_text(size=16,hjust=0.5))


## egg::ggarrange(pEff.kSat,pEff.phiJ,pEff.Rd,nrow=3,ncol=1)



## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## ~~~~~~~~~~~~~~~~ Mean Efficiency per A/Ci Curve date ~~~~~~~~~~~~~~~~ ##

meanEfficiencyAciCurveList <- list()
meanEfficiencyAciCurveList <- lapply(sapDataCT,meanPerDate,datesArray=aciCurveDates)

meanEfficiencyAciCurveData <- do.call("rbind",meanEfficiencyAciCurveList)%>%
    select(-treeNo_se)%>%
    rename(treeNo=treeNo_mean)%>%
    left_join(tibble(treeNo=treeOrder,id=treeID),by="treeNo")%>%
    rename(date=timestamp)
    
aciCurveEff <- aciCurveParFit%>%
    unite(id,c("treatment","tree"),sep="-")%>%
    mutate(date=as.Date(date))%>%
    left_join(meanEfficiencyAciCurveData,by=c("date","id"))%>%
    mutate(ID=id)%>%
    separate(ID,c("treatment","treeNo"))



## Fit the model for Vcmax vs mean efficiency
fit.vcmax <- nlsLM(data = aciCurveEff, n_mean ~ Michaelis_Menten(V_cmax,slope=slope,sat,r),
                 start = list(sat = 0.9,
                              slope = 1,
                              r = 1),
                 ## lower = c(min(cntr$A),0, 0, 0),
                 ## upper = c(10 * max(abs(cntr$A)), 0.5, 1, max(abs(cntr$A))),
                 control = nls.lm.control(maxiter = 1000))
summary(fit.vcmax)
calculateRsq(data=aciCurveEff,modelFit = fit.vcmax,depVar = n_mean)
pred.vcmax<-tibble(vcmax=seq(2,70,1.1),n.pred=Michaelis_Menten(vcmax,slope=coef(fit.vcmax)[[2]],sat=coef(fit.vcmax)[[1]],r=coef(fit.vcmax)[[3]]))#%>%slice(2:nrow(pred.vcmax))
nrow(pred.vcmax)

## Fit the model for Jmax vs mean efficiency
fit.jmax <- nlsLM(data = aciCurveEff, n_mean ~ Michaelis_Menten(J_max,slope=slope,sat,r),
                 start = list(sat = 0.9,
                              slope = 1,
                              r = 1),
                 ## lower = c(min(cntr$A),0, 0, 0),
                 ## upper = c(10 * max(abs(cntr$A)), 0.5, 1, max(abs(cntr$A))),
                 control = nls.lm.control(maxiter = 1000))
summary(fit.jmax)
calculateRsq(data=aciCurveEff,modelFit = fit.jmax,depVar = n_mean)
pred.jmax<-tibble(jmax=seq(10,200,3),n.pred=Michaelis_Menten(jmax,slope=coef(fit.jmax)[[2]],sat=coef(fit.jmax)[[1]],r=coef(fit.jmax)[[3]]))
nrow(pred.jmax)


labels <- c("First wet","First drought","Second wet")
names(labels) <- aciCurveDates

pEff.Vcmax <- aciCurveEff%>%
    ggplot(.)+
    geom_point(aes(V_cmax,n_mean,shape=treatment,colour=as.factor(date)),size=3)+
    geom_line(data=pred.vcmax,aes(x=vcmax,y=n.pred))+
    plotAesthetic+
    annotate("rect",xmin=min(aciCurveEff$V_cmax),xmax=max(aciCurveEff$V_cmax),ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
    ## area of most efficient water transport
    annotate("rect",xmin=min(aciCurveEff$V_cmax),xmax=max(aciCurveEff$V_cmax),ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
    ## area of moderately efficient water transport
    annotate("rect",xmin=min(aciCurveEff$V_cmax),xmax=max(aciCurveEff$V_cmax),ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
    ## area of moderately unrestricted of water transport
    annotate("rect",xmin=min(aciCurveEff$V_cmax),xmax=max(aciCurveEff$V_cmax),ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
    ## area of unrestricted water supply
    annotate("rect",xmin=min(aciCurveEff$V_cmax),xmax=max(aciCurveEff$V_cmax),ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
    scale_colour_manual(values=c(1,2,3,4),labels=labels,name="Period")+
    scale_shape_discrete(name="Treatment")+
    theme(#panel.grid=element_blank(),
        plot.margin=unit(c(0,0,0,1),"cm"),
        strip.text=element_blank(),
        ## strip.background=element_blank(),
        axis.text.y=element_text(size=16,colour="black"),
        axis.title.y=element_text(size=16),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        axis.text.x=element_text(size=16),#element_blank(),#
        axis.title.x=element_text(size=16),#=element_blank(),
        plot.title=element_text(size=16,hjust=0.5))


pEff.Jmax <- aciCurveEff%>%
    ggplot(.)+
    geom_point(aes(J_max,n_mean,shape=treatment,colour=as.factor(date)),size=3)+
    geom_line(data=pred.jmax,aes(x=jmax,y=n.pred))+
    plotAesthetic+
    annotate("rect",xmin=min(aciCurveEff$J_max),xmax=max(aciCurveEff$J_max),ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
    ## area of most efficient water transport
    annotate("rect",xmin=min(aciCurveEff$J_max),xmax=max(aciCurveEff$J_max),ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
    ## area of moderately efficient water transport
    annotate("rect",xmin=min(aciCurveEff$J_max),xmax=max(aciCurveEff$J_max),ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
    ## area of moderately unrestricted of water transport
    annotate("rect",xmin=min(aciCurveEff$J_max),xmax=max(aciCurveEff$J_max),ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
    ## area of unrestricted water supply
    annotate("rect",xmin=min(aciCurveEff$J_max),xmax=max(aciCurveEff$J_max),ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
    scale_colour_manual(values=c(1,2,3,4),labels=labels,name="Period")+
    scale_shape_discrete(name="Treatment")+
    theme(#panel.grid=element_blank(),
        plot.margin=unit(c(0,0,0,1),"cm"),
        strip.text=element_blank(),
        ## strip.background=element_blank(),
        axis.text.y=element_text(size=16,colour="black"),
        axis.title.y=element_text(size=16),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        axis.text.x=element_text(size=16),#element_blank(),#
        axis.title.x=element_text(size=16),#=element_blank(),
        plot.title=element_text(size=16,hjust=0.5))


pEff.R_d <- aciCurveEff%>%
    ggplot(.)+
    geom_point(aes(R_d,n_mean,shape=treatment,colour=as.factor(date)),size=3)+
    plotAesthetic+
    annotate("rect",xmin=min(lightCurveEff$R_d),xmax=max(lightCurveEff$R_d),ymin=0,ymax=0.412,fill="orangered",alpha=0.2,colour=NA)+
    ## area of most efficient water transport
    annotate("rect",xmin=min(lightCurveEff$R_d),xmax=max(lightCurveEff$R_d),ymin=0.412,ymax=0.565,fill="springgreen",alpha=0.4,colour=NA)+
    ## area of moderately efficient water transport
    annotate("rect",xmin=min(lightCurveEff$R_d),xmax=max(lightCurveEff$R_d),ymin=0.565,ymax=0.75,fill="cyan",alpha=0.2,colour=NA)+
    ## area of moderately unrestricted of water transport
    annotate("rect",xmin=min(lightCurveEff$R_d),xmax=max(lightCurveEff$R_d),ymin=0.75,ymax=0.89,fill="magenta",alpha=0.2,colour=NA)+
    ## area of unrestricted water supply
    annotate("rect",xmin=min(lightCurveEff$R_d),xmax=max(lightCurveEff$R_d),ymin=0.89,ymax=1,fill="grey90",alpha=0.4,colour=NA)+
    scale_colour_manual(values=c(1,2,3,4),labels=labels,name="Period")+
    scale_shape_discrete(name="Treatment")+
    theme(#panel.grid=element_blank(),
        plot.margin=unit(c(0,0,0,1),"cm"),
        strip.text=element_blank(),
        ## strip.background=element_blank(),
        axis.text.y=element_text(size=16,colour="black"),
        axis.title.y=element_text(size=16),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        axis.text.x=element_text(size=16),#element_blank(),#
        axis.title.x=element_text(size=16),#=element_blank(),
        plot.title=element_text(size=16,hjust=0.5))

## egg::ggarrange(pEff.Vcmax,pEff.Jmax,nrow=1,ncol=2)


## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

```


## Mean hydraulic efficiency vs gas exchange fitted parameters
For each survey date, I fitted light and A/Ci curves. For the same dates and for between 8 a.m. to 3 p.m. hydraulic efficiency was averaged for each tree and plotted against the key fitted parametesr of the light and A/Ci curves. The plots show Ksat, PhiJ, Vcmax and Jmax. We see that for three out of four parameters there is a Michaelis-Menten response suggesting that water stress trees have lower maximum photosynthesis and both rate of carboxylation and electron transport. Furthermore, it clearly shows that the new methodology although its calculations is based on water there is a relationship which photosynthesis, since water limitation will impact stomata opening and limit carbon capture and restrict photosynthesis. It increases my confidence that $\eta$ is good in monitoring both water stress and photosynthetic limitation.

```{r,fig.width=20,fig.height=14}
egg::ggarrange(pEff.kSat,pEff.phiJ,pEff.Vcmax,pEff.Jmax,nrow=2,ncol=2)

```
